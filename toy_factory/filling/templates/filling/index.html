{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
      .slider-round {
        background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px;
      }
      .slider-round:before {
        background-color: white; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%;
      }
      input:checked + .slider-round { background-color: var(--accent-color); }
      input:checked + .slider-round:before { transform: translateX(20px); }

      /* Точки пагинации */
      .slider-dots { text-align: center; margin-top: -30px; position: relative; z-index: 10; }
      .dot { display: inline-block; width: 12px; height: 12px; background: rgba(255,255,255,0.5); margin: 0 5px; border-radius: 50%; cursor: pointer; }
      .dot.active { background: #fff; transform: scale(1.2); }

      /* Счетчик слайдов */
      .slider-counter {
          position: absolute; top: 10px; right: 10px;
          background: rgba(0,0,0,0.5); color: white;
          padding: 5px 10px; border-radius: 15px; font-size: 14px; z-index: 10;
      }
  </style>
{% endblock %}

{% block content %}

<div class="preloader-overlay">
    <div class="figure-preloader-container">
        <div class="preloader-part left"></div>
        <div class="preloader-part right"></div>
    </div>
    <p>Загрузка ...</p>
</div>

<main class="home-page">

  <section class="hero-logo">
    <img src="{% static 'images/logo.png' %}" alt="Логотип компании" style="max-width: 200px; display: block; margin: 0 auto;">
  </section>

  <section class="banner-slider">
    <div id="mySlider" class="slider"
         data-delay="{{ slider_settings.delay|default:5000 }}"
         data-auto="{{ slider_settings.is_auto|yesno:'true,false' }}"
         data-loop="{{ slider_settings.is_loop|yesno:'true,false' }}"
         data-navs="true"
         data-pags="true"
         data-stop-mouse-hover="true">

         <div class="slider-counter"></div>

         {% for slide in slides %}
            <div class="slide {% if forloop.first %}active{% endif %}">
                <a href="{{ slide.link }}">
                    <img src="{{ slide.image.url }}" alt="{{ slide.title }}">
                </a>
                <div style="position: absolute; bottom: 40px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px;">
                    {{ slide.title }}
                </div>
            </div>
         {% empty %}
            <div class="slide active">
                <img src="https://via.placeholder.com/1200x400?text=Слайдов+нет" alt="Нет слайдов">
            </div>
         {% endfor %}

         <div class="slider-controls"></div>
    </div>

    <div class="slider-dots"></div>

    {% if user.is_staff %}
    <div class="admin-slider-controls" style="position: absolute; top: 10px; left: 10px; z-index: 20; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; color: white; font-family: sans-serif; font-size: 14px; max-width: 300px;">
        <h4 style="margin: 0 0 12px 0; color: #fff;">Управление слайдером (админ)</h4>

        <div style="margin-bottom: 10px;">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="admin-auto-toggle" {% if slider_settings.is_auto %}checked{% endif %}>
                Автоплей
            </label>
        </div>

        <div style="margin-bottom: 10px;">
            <label style="display: block;">
                Скорость (мс):
                <input type="number" id="admin-delay-input" value="{{ slider_settings.delay }}" min="1000" max="30000" step="500" style="width: 90px; padding: 4px; margin-left: 8px;">
            </label>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="admin-loop-toggle" {% if slider_settings.is_loop %}checked{% endif %}>
                Бесконечная прокрутка
            </label>
        </div>

        <div style="margin-bottom: 8px;">
            <a href="{% url 'admin:filling_promoslide_changelist' %}" target="_blank" style="color: #fff; text-decoration: underline; font-size: 14px;">
                → Управление слайдами (добавить/удалить/порядок)
            </a>
        </div>

        {% if slider_settings.id %}
        <div>
            <a href="{% url 'admin:filling_slidersettings_change' slider_settings.id %}" target="_blank" style="color: #bbb; text-decoration: underline; font-size: 12px;">
                → Редактировать настройки в админке
            </a>
        </div>
        {% else %}
        <div style="color: orange; font-size: 12px;">
            Настройки слайдера ещё не созданы.<br>
            Перейдите в админку → Slider Settings и создайте запись.
        </div>
        {% endif %}
    </div>
    {% endif %}

  </section>

  <section class="about-company">
    <h2>О компании</h2>
    <p>Наша компания занимается производством и продажей лучших игрушек. Мы гарантируем качество и заботимся о клиентах.</p>
  </section>

  <section id="animation-demo">
      <div class="animation-container">
          <div class="teddy-bear">
              <div class="teddy-head-main">
                  <div class="teddy-ear left"></div>
                  <div class="teddy-ear right"></div>
                  <div class="teddy-eye left"></div>
                  <div class="teddy-eye right"></div>
                  <div class="teddy-nose-main"></div>
              </div>
              <div class="teddy-arm left"></div>
              <div class="teddy-arm right"></div>
          </div>
          <div class="balloons-container">
              <div class="balloon"></div>
              <div class="balloon"></div>
              <div class="balloon"></div>
          </div>
      </div>
      <div class="company-name-reveal">MEGA</div>
  </section>

  <section class="latest-news">
    <h2>Последние новости</h2>
    {% if latest_articles %}
      <ul>
        {% for article in latest_articles %}
          <li>
            <a href="{{ article.get_absolute_url }}">
                <strong>{{ article.title }}</strong>
            </a>
            <span style="color: grey; font-size: 0.9em;">({{ article.time|date:"d.m.Y" }})</span>
            <p>{{ article.description|truncatewords:20 }}</p>
          </li>
        {% endfor %}
      </ul>
      <a href="{% url 'filling:news' %}" class="more-news">Все новости →</a>
    {% else %}
      <p>Новостей пока нет. Добавьте их в админке.</p>
    {% endif %}
  </section>

</main>

<script>
class Slider {
    constructor(selector) {
        this.container = document.querySelector(selector);
        if (!this.container) return;

        this.slides = this.container.querySelectorAll('.slide');
        this.totalSlides = this.slides.length;
        this.currentIndex = 0;
        this.intervalId = null;

        const data = this.container.dataset;
        this.settings = {
            loop: (data.loop === 'true'),
            navs: (data.navs === 'true'),
            pags: (data.pags === 'true'),
            auto: (data.auto === 'true'),
            stopMouseHover: (data.stopMouseHover === 'true'),
            delay: parseInt(data.delay) || 5000
        };

        this.counterEl = this.container.querySelector('.slider-counter');
        this.controlsContainer = this.container.querySelector('.slider-controls');
        this.dotsContainer = this.container.parentElement.querySelector('.slider-dots');

        this.init();
    }

    init() {
        if (this.totalSlides === 0) return;

        if (this.settings.navs && this.controlsContainer) {
            this.controlsContainer.innerHTML = `
                <button class="prev">‹</button>
                <button class="next">›</button>
            `;
            this.controlsContainer.querySelector('.prev').addEventListener('click', () => {
                this.prev(); this.resetAuto();
            });
            this.controlsContainer.querySelector('.next').addEventListener('click', () => {
                this.next(); this.resetAuto();
            });
        }

        if (this.settings.pags && this.dotsContainer) {
            this.dotsContainer.innerHTML = '';
            this.slides.forEach((_, i) => {
                const dot = document.createElement('span');
                dot.className = 'dot';
                if (i === 0) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    this.goTo(i); this.resetAuto();
                });
                this.dotsContainer.appendChild(dot);
            });
        }

        if (this.settings.auto) {
            this.startAuto();
            if (this.settings.stopMouseHover) {
                this.container.addEventListener('mouseenter', () => this.stopAuto());
                this.container.addEventListener('mouseleave', () => this.startAuto());
            }
        }

        this.updateView();
    }

    updateView() {
        this.slides.forEach((slide, index) => {
            slide.classList.toggle('active', index === this.currentIndex);
        });

        if (this.counterEl) {
            this.counterEl.innerText = `${this.currentIndex + 1} / ${this.totalSlides}`;
        }

        if (this.dotsContainer) {
            const dots = this.dotsContainer.querySelectorAll('.dot');
            dots.forEach((d, i) => {
                d.classList.toggle('active', i === this.currentIndex);
            });
        }
    }

    next() {
        if (this.currentIndex < this.totalSlides - 1) {
            this.currentIndex++;
        } else if (this.settings.loop) {
            this.currentIndex = 0;
        }
        this.updateView();
    }

    prev() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
        } else if (this.settings.loop) {
            this.currentIndex = this.totalSlides - 1;
        }
        this.updateView();
    }

    goTo(index) {
        this.currentIndex = index;
        this.updateView();
    }

    startAuto() {
        if (this.intervalId) clearInterval(this.intervalId);
        this.intervalId = setInterval(() => this.next(), this.settings.delay);
    }

    stopAuto() {
        if (this.intervalId) clearInterval(this.intervalId);
    }

    resetAuto() {
        this.stopAuto();
        if (this.settings.auto) this.startAuto();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.body.classList.add('loaded');
    }, 2000);

    let sliderInstance = new Slider('#mySlider');

    {% if user.is_staff %}
    const autoToggle = document.getElementById('admin-auto-toggle');
    const delayInput = document.getElementById('admin-delay-input');
    const loopToggle = document.getElementById('admin-loop-toggle');

    if (autoToggle) {
        autoToggle.addEventListener('change', () => {
            sliderInstance.settings.auto = autoToggle.checked;
            if (autoToggle.checked) {
                sliderInstance.startAuto();
            } else {
                sliderInstance.stopAuto();
            }
        });
    }

    if (delayInput) {
        delayInput.addEventListener('change', () => {
            const newDelay = parseInt(delayInput.value) || 5000;
            sliderInstance.settings.delay = newDelay;
            if (sliderInstance.settings.auto) {
                sliderInstance.resetAuto();
            }
        });
    }

    if (loopToggle) {
        loopToggle.addEventListener('change', () => {
            sliderInstance.settings.loop = loopToggle.checked;
        });
    }
    {% endif %}
});
</script>
{% endblock %}