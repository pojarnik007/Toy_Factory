{% extends 'base.html' %}
{% load static %}
{% load user_tags %}

{% block extra_css %}
{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{% static 'css/products.css' %}">
    <h1 class="page-title">Каталог игрушек</h1>

    {% if user|is_admin or user|is_employee %}
        <a href="{% url 'production:create' %}" class="btn btn-primary add-btn">
            + Добавить новую игрушку
        </a>
    {% endif %}

    <form method="get" class="filters">
        <input type="text" name="q" class="search-input" placeholder="Поиск..." value="{{ request.GET.q }}">

        <select name="sort" class="select-input">
            <option value="">Сортировать...</option>
            <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Цена ↑</option>
            <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Цена ↓</option>
            <option value="name_asc" {% if request.GET.sort == 'name_asc' %}selected{% endif %}>Название А-Я</option>
            <option value="name_desc" {% if request.GET.sort == 'name_desc' %}selected{% endif %}>Название Я-А</option>
        </select>

        <select name="per_page" class="select-input" onchange="this.form.submit()">
            <option value="3" {% if request.GET.per_page == '3' %}selected{% endif %}>3 на стр.</option>
            <option value="6" {% if request.GET.per_page == '6' %}selected{% endif %}>6 на стр.</option>
            <option value="9" {% if request.GET.per_page == '9' %}selected{% endif %}>9 на стр.</option>
        </select>

        <div class="checkbox-group">
            <label>Вид игрушки:</label>
            {% for type in all_types %}
                <label class="checkbox-item">
                    <input type="checkbox" name="types" value="{{ type.id }}"
                           {% if type.id|stringformat:"s" in selected_types %}checked{% endif %}>
                    {{ type.name }}
                </label>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-secondary">Фильтровать</button>
    </form>

    <div class="products-grid">
        {% for toy in page_obj %}
            <div class="product-card">
                <a href="{% url 'production:detail' toy.pk %}">
                    <h3 class="product-title">{{ toy.name }}</h3>
                </a>
                <p class="product-info">
                    Код: {{ toy.code }} | Вид: {{ toy.toy_type }}<br>
                    Цена: <span class="price">{{ toy.price }} ₽</span><br>
                    В наличии: {{ toy.in_stock }}
                </p>

                {% if toy.image %}
                    <img src="{{ toy.image.url }}" alt="{{ toy.name }}" class="product-img">
                {% endif %}

                <div class="product-actions">
                    {% if user|is_client and toy.is_active and toy.in_stock > 0 %}
                        <form action="{% url 'production:add_to_cart' toy.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">В корзину</button>
                        </form>
                    {% elif toy.is_active and toy.in_stock > 0 %}
                        <p><em>Только для покупателей</em></p>
                    {% else %}
                        <p class="out-of-stock"><em>Нет в наличии</em></p>
                    {% endif %}
                </div>

                {% if user|is_admin %}
                    <div class="admin-actions">
                        <a href="{% url 'production:edit' toy.pk %}" class="btn btn-warning btn-sm">Ред.</a>
                        <a href="{% url 'production:delete' toy.pk %}" class="btn btn-danger btn-sm"
                           onclick="return confirm('Точно удалить?');">Удал.</a>
                    </div>
                {% endif %}
            </div>
        {% empty %}
            <p>Игрушки не найдены</p>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination">

            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&sort={{ request.GET.sort }}&per_page={{ request.GET.per_page }}" class="page-link">&laquo;</a>
            {% else %}
                <span class="page-link disabled">&laquo;</span>
            {% endif %}

            {% for p in page_obj.paginator.page_range %}
                {% if page_obj.number == p %}
                    <span class="page-link active">{{ p }}</span>
                {% elif p >= page_obj.number|add:-2 and p <= page_obj.number|add:2 %}
                    <a href="?page={{ p }}&q={{ request.GET.q }}&sort={{ request.GET.sort }}&per_page={{ request.GET.per_page }}" class="page-link">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&sort={{ request.GET.sort }}&per_page={{ request.GET.per_page }}" class="page-link">&raquo;</a>
            {% else %}
                <span class="page-link disabled">&raquo;</span>
            {% endif %}

        </div>
        <p class="page-info">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</p>
    </div>
        <script src="{% static 'js/tilt_effect.js' %}"></script>
    {% endif %}

{% endblock %}